name: TodoApp CI/CD Pipeline
on:
  push:
    branches: [ main, develop ]

env:
  APP_NAME: "todo-webapp"
  VERSION: "1.0.${{ github.run_number }}"
  DOCKER_IMAGE: "charantejafk/todo-webapp"

# Add permissions at workflow level to fix security warnings
permissions:
  contents: read
  security-events: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ==================== CHECKOUT CODE ====================
    - name: Checkout Code
      uses: actions/checkout@v4

    # ==================== SETUP JAVA & MAVEN ====================
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    # ==================== BUILD WAR ====================
    - name: Build WAR
      run: |
        echo "üî® Building WAR file..."
        mvn clean package -DskipTests
        echo "üì¶ Generated artifacts:"
        ls -la target/
        # Copy WAR file to root for Docker
        cp target/*.war app.war 2>/dev/null || echo "No WAR file found - check Maven build"

    # ==================== SETUP DOCKER ====================
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # ==================== BUILD DOCKER IMAGE ====================
    - name: Build Docker Image
      run: |
        echo "üê≥ Building Docker image..."
        docker build -t $DOCKER_IMAGE:$VERSION .
        docker tag $DOCKER_IMAGE:$VERSION $DOCKER_IMAGE:latest
        echo "üìã Built images:"
        docker images | grep $DOCKER_IMAGE

    # ==================== SECURITY SCAN (OPTIONAL - SKIP IF ISSUES) ====================
    - name: Run Trivy vulnerability scanner
      id: trivy-scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: $DOCKER_IMAGE:$VERSION
        format: 'table'
      continue-on-error: true

    # ==================== PUSH TO DOCKER HUB ====================
    - name: Push Docker Image
      env:
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      run: |
        echo "üì§ Pushing Docker image to Docker Hub..."
        echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin
        docker push $DOCKER_IMAGE:$VERSION
        docker push $DOCKER_IMAGE:latest
        echo "‚úÖ Images pushed successfully"

    # ==================== SUCCESS MESSAGE ====================
    - name: Pipeline Success
      run: |
        echo "üéâ CI/CD PIPELINE COMPLETED SUCCESSFULLY!"
        echo "=========================================="
        echo ""
        echo "üìä Build Information:"
        echo "   - Application: $APP_NAME"
        echo "   - Version: $VERSION"
        echo "   - Docker Image: $DOCKER_IMAGE:latest"
        echo ""
        echo "üöÄ Deployment Ready!"
        echo "   Run these commands on your server (184.73.21.57):"
        echo ""
        echo "   # Pull and deploy the new version"
        echo "   docker pull $DOCKER_IMAGE:latest"
        echo "   docker rm -f todo-webapp || true"
        echo "   docker run -d --name todo-webapp --network cicd-network -p 8080:8080 $DOCKER_IMAGE:latest"
        echo ""
        echo "   # Verify deployment"
        echo "   curl http://184.73.21.57:8080/todos"
        echo ""
        echo "üåê Application URL: http://184.73.21.57:8080/todos"
        echo "üê≥ Docker Hub: https://hub.docker.com/r/charantejafk/todo-webapp"
