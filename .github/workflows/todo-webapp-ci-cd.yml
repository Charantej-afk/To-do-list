name: CI/CD Pipeline - SSH Container Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE: charantejafk/todo-webapp
  DEPLOYMENT_SERVER: 184.73.21.57
  SSH_USER: ubuntu

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build with Maven
        run: mvn clean compile -DskipTests
      
      - name: Run tests
        run: mvn test
      
      - name: Package WAR
        run: mvn package -DskipTests
      
      - name: Upload WAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: webapp-war
          path: target/*.war
          retention-days: 7

  build-and-push-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download WAR artifact
        uses: actions/download-artifact@v4
        with:
          name: webapp-war
          path: target/
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Copy WAR file for Docker
        run: |
          cp target/*.war ROOT.war
          echo "üì¶ WAR file ready for Docker build"
          ls -la ROOT.war
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ github.run_number }}
            ${{ env.DOCKER_IMAGE }}:latest
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
      
      - name: Verify Docker image
        run: |
          echo "‚úÖ Docker image pushed successfully:"
          echo "   - ${{ env.DOCKER_IMAGE }}:${{ github.run_number }}"
          echo "   - ${{ env.DOCKER_IMAGE }}:latest"

  deploy-to-container-host:
    name: Deploy to Container Host via SSH
    runs-on: ubuntu-latest
    needs: build-and-push-docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Check SSH connectivity
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEPLOYMENT_SERVER }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üîß Checking Docker environment..."
            docker --version
            docker ps
            docker network ls | grep cicd-network || echo "cicd-network not found"
            echo "‚úÖ SSH and Docker working"

      - name: Deploy Application Container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEPLOYMENT_SERVER }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üöÄ Starting deployment process..."
            
            # Pull latest image
            echo "üì• Pulling latest Docker image..."
            docker pull ${{ env.DOCKER_IMAGE }}:latest
            
            # Stop and remove existing container
            echo "üõë Stopping existing container..."
            docker rm -f todo-webapp || true
            
            # Deploy new container
            echo "üéØ Deploying new container..."
            docker run -d \
              --name todo-webapp \
              --network cicd-network \
              -p 8080:8080 \
              ${{ env.DOCKER_IMAGE }}:latest
            
            echo "‚úÖ Container deployed successfully"

      - name: Wait for application startup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEPLOYMENT_SERVER }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "‚è≥ Waiting for application to start..."
            for i in {1..30}; do
              if curl -s http://localhost:8080/todos > /dev/null 2>&1; then
                echo "‚úÖ Application is responding!"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "‚ùå Application failed to start within timeout"
                docker logs todo-webapp
                exit 1
              fi
              echo "Attempt $i/30: Waiting..."
              sleep 2
            done

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEPLOYMENT_SERVER }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üîç Verifying deployment..."
            
            # Check container status
            echo "üìä Container status:"
            docker ps | grep todo-webapp
            
            # Test the application
            echo "üåê Testing application endpoint..."
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/todos)
            echo "HTTP Status: $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "üéâ DEPLOYMENT SUCCESSFUL!"
              echo "üåê Your Todo App is live at: http://${{ env.DEPLOYMENT_SERVER }}:8080/todos"
            else
              echo "‚ö†Ô∏è Application returned HTTP $HTTP_STATUS"
              echo "üìã Container logs:"
              docker logs todo-webapp --tail 20
              # Don't fail, just warn
            fi

      - name: Final health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEPLOYMENT_SERVER }}
          username: ${{ env.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üè• Final health check..."
            echo "Container status: $(docker inspect --format='{{.State.Status}}' todo-webapp)"
            echo "Running for: $(docker inspect --format='{{.State.StartedAt}}' todo-webapp)"
            echo "üåê Application URL: http://${{ env.DEPLOYMENT_SERVER }}:8080/todos"

  pipeline-success:
    name: Pipeline Success
    runs-on: ubuntu-latest
    needs: deploy-to-container-host
    if: always()
    
    steps:
      - name: Final success message
        run: |
          echo "üéâ CI/CD PIPELINE COMPLETED!"
          echo "============================="
          echo ""
          echo "‚úÖ Build: Successful"
          echo "‚úÖ Docker Image: ${{ env.DOCKER_IMAGE }}:latest"
          echo "‚úÖ Deployment: Completed via SSH"
          echo ""
          echo "üåê Your Todo Application is deployed at:"
          echo "   http://${{ env.DEPLOYMENT_SERVER }}:8080/todos"
          echo ""
          echo "üê≥ Container running on: ${{ env.DEPLOYMENT_SERVER }}"
          echo "üìä To check container status:"
          echo "   ssh ${{ env.SSH_USER }}@${{ env.DEPLOYMENT_SERVER }} 'docker ps'"
          echo ""
          echo "üöÄ Deployment Method: SSH to Container Host"
