name: TodoApp CI/CD Pipeline
on:
  push:
    branches: [ main, develop ]

env:
  APP_NAME: "todo-webapp"
  VERSION: "1.0.${{ github.run_number }}"
  DOCKER_IMAGE: "charantejafk/todo-webapp"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ==================== CHECKOUT CODE ====================
    - name: Checkout Code
      uses: actions/checkout@v4

    # ==================== SETUP JAVA & MAVEN ====================
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    # ==================== BUILD WAR ====================
    - name: Build WAR
      run: |
        echo "ğŸ”¨ Building WAR file..."
        mvn clean package -DskipTests
        echo "ğŸ“¦ Generated artifacts:"
        ls -la target/
        # Verify WAR file exists
        if [ ! -f target/*.war ]; then
          echo "âŒ No WAR file found!"
          exit 1
        fi

    # ==================== SETUP DOCKER ====================
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # ==================== BUILD DOCKER IMAGE ====================
    - name: Build Docker Image
      run: |
        echo "ğŸ³ Building Docker image..."
        # List available images for debugging
        echo "Available Maven images on Docker Hub:"
        echo "- maven:3.8.7-openjdk-17"
        echo "- maven:3.9.6-eclipse-temurin-17" 
        echo "- maven:3.8.6-openjdk-17"
        
        # Build with simple Dockerfile
        docker build -t $DOCKER_IMAGE:$VERSION .
        docker tag $DOCKER_IMAGE:$VERSION $DOCKER_IMAGE:latest
        echo "ğŸ“‹ Built images:"
        docker images | grep $DOCKER_IMAGE

    # ==================== SECURITY SCAN ====================
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: $DOCKER_IMAGE:$VERSION
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    # ==================== PUSH TO DOCKER HUB ====================
    - name: Push Docker Image
      env:
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      run: |
        echo "ğŸ“¤ Pushing Docker image to Docker Hub..."
        echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin
        docker push $DOCKER_IMAGE:$VERSION
        docker push $DOCKER_IMAGE:latest
        echo "âœ… Images pushed successfully"

    # ==================== GENERATE DEPLOYMENT SCRIPT ====================
    - name: Create Deployment Script
      run: |
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        echo "ğŸš€ Deploying Todo Application..."
        
        # Pull latest image
        docker pull charantejafk/todo-webapp:latest
        
        # Stop and remove existing container
        docker rm -f todo-webapp || true
        
        # Deploy new container
        docker run -d \
          --name todo-webapp \
          --network cicd-network \
          -p 8080:8080 \
          charantejafk/todo-webapp:latest
        
        # Wait for startup
        sleep 30
        
        # Verify deployment
        echo "ğŸ” Verifying deployment..."
        if curl -s -f http://localhost:8080/todos > /dev/null; then
          echo "âœ… Deployment successful! Application is running."
          echo "ğŸŒ Access your app at: http://$(curl -s ifconfig.me):8080/todos"
        else
          echo "âŒ Deployment failed - application not responding"
          exit 1
        fi
        EOF
        chmod +x deploy.sh
        echo "ğŸ“„ Deployment script created"

    # ==================== FINAL INSTRUCTIONS ====================
    - name: Show Deployment Instructions
      run: |
        echo "ğŸ¯ DEPLOYMENT INSTRUCTIONS"
        echo "=========================="
        echo ""
        echo "âœ… BUILD COMPLETED SUCCESSFULLY!"
        echo "ğŸ“¦ Docker Image: charantejafk/todo-webapp:latest"
        echo "ğŸ·ï¸  Version: $VERSION"
        echo ""
        echo "ğŸš€ TO DEPLOY:"
        echo "1. SSH to your server:"
        echo "   ssh ubuntu@184.73.21.57"
        echo ""
        echo "2. Run deployment commands:"
        echo "   docker pull charantejafk/todo-webapp:latest"
        echo "   docker rm -f todo-webapp || true"
        echo "   docker run -d --name todo-webapp --network cicd-network -p 8080:8080 charantejafk/todo-webapp:latest"
        echo ""
        echo "3. Verify deployment:"
        echo "   curl http://localhost:8080/todos"
        echo ""
        echo "ğŸŒ PUBLIC URL: http://184.73.21.57:8080/todos"
