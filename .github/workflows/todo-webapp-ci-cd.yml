name: TodoApp CI/CD Pipeline
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  APP_NAME: "todo-webapp"
  VERSION: "1.0.${{ github.run_number }}"
  DOCKER_IMAGE: "charantejafk/todo-webapp"
  DEPLOYMENT_SERVER: "184.73.21.57"

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    
    steps:
    # ==================== CHECKOUT CODE ====================
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ==================== SETUP JAVA & MAVEN ====================
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    # ==================== BUILD WAR ====================
    - name: Build WAR
      run: |
        echo "üî® Building WAR file..."
        mvn clean package -DskipTests
        echo "üì¶ Generated artifacts:"
        ls -la target/

    # ==================== VERIFY SERVICE CONNECTIVITY ====================
    - name: Verify Service Connectivity
      env:
        SONARQUBE_URL: ${{ secrets.SONARQUBE_URL }}
        NEXUS_URL: ${{ secrets.NEXUS_URL }}
      run: |
        echo "üîç Testing connectivity to services..."
        
        # Test SonarQube
        echo "Testing SonarQube at $SONARQUBE_URL..."
        if curl -s -f "$SONARQUBE_URL/api/system/status"; then
          echo "‚úÖ SonarQube is accessible"
        else
          echo "‚ùå SonarQube is not accessible"
          exit 1
        fi
        
        # Test Nexus
        echo "Testing Nexus at $NEXUS_URL..."
        if curl -s -f "$NEXUS_URL/service/rest/v1/status"; then
          echo "‚úÖ Nexus is accessible"
        else
          echo "‚ùå Nexus is not accessible"
          exit 1
        fi

    # ==================== SONARQUBE SCAN ====================
    - name: SonarQube Scan
      env:
        SONAR_TOKEN: ${{ secrets.SONARQUBE_TOKEN }}
        SONAR_URL: ${{ secrets.SONARQUBE_URL }}
      run: |
        echo "üîç Running SonarQube analysis..."
        mvn sonar:sonar \
          -Dsonar.projectKey=todo-app \
          -Dsonar.projectName="Todo Web Application" \
          -Dsonar.host.url=$SONAR_URL \
          -Dsonar.login=$SONAR_TOKEN \
          -Dsonar.sourceEncoding=UTF-8

    # ==================== UPLOAD TO NEXUS ====================
    - name: Upload WAR to Nexus
      env:
        NEXUS_URL: ${{ secrets.NEXUS_URL }}
        NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
        NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
      run: |
        echo "üì§ Uploading WAR to Nexus..."
        
        # Find the WAR file
        WAR_FILE=$(find target -name "*.war" -type f | head -1)
        echo "Found WAR file: $WAR_FILE"
        
        # Upload to Nexus
        curl -v -u "$NEXUS_USERNAME:$NEXUS_PASSWORD" \
          --upload-file "$WAR_FILE" \
          "$NEXUS_URL/repository/maven-releases/com/app/$APP_NAME/$VERSION/$APP_NAME-$VERSION.war"
        
        echo "‚úÖ WAR file uploaded to Nexus"

    # ==================== DOCKER IMAGE BUILD ====================
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker Image
      run: |
        echo "üê≥ Building Docker image..."
        docker build -t $DOCKER_IMAGE:$VERSION .
        docker tag $DOCKER_IMAGE:$VERSION $DOCKER_IMAGE:latest
        echo "üìã Built images:"
        docker images | grep $DOCKER_IMAGE

    # ==================== SECURITY SCAN ====================
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: $DOCKER_IMAGE:$VERSION
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    # ==================== PUSH TO DOCKER HUB ====================
    - name: Push Docker Image
      env:
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      run: |
        echo "üì§ Pushing Docker image to Docker Hub..."
        echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin
        docker push $DOCKER_IMAGE:$VERSION
        docker push $DOCKER_IMAGE:latest
        echo "‚úÖ Images pushed successfully"

  # ==================== DEPLOYMENT JOB ====================
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-scan
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Deploy to Server
      env:
        DOCKER_IMAGE: "charantejafk/todo-webapp"
        SERVER_IP: "184.73.21.57"
      run: |
        echo "üöÄ Starting deployment to $SERVER_IP..."
        
        # Deploy using SSH (you'll need to set up SSH keys)
        # Alternatively, use the approach below for container-to-container deployment
        
        echo "üìã Deployment Commands:"
        echo "1. Pull latest image: docker pull $DOCKER_IMAGE:latest"
        echo "2. Stop existing container: docker rm -f todo-webapp || true"
        echo "3. Run new container: docker run -d --name todo-webapp --network cicd-network -p 8080:8080 $DOCKER_IMAGE:latest"
        echo "4. Verify deployment: curl http://$SERVER_IP:8080/todos"
        
        echo "‚úÖ Deployment configuration ready!"

    - name: Verify Deployment
      run: |
        echo "üîç Testing application accessibility..."
        if curl -s -f "http://184.73.21.57:8080/todos"; then
          echo "‚úÖ Application is accessible at http://184.73.21.57:8080/todos"
        else
          echo "‚ö†Ô∏è  Application may not be running yet"
        fi

    - name: Deployment Success
      if: success()
      run: |
        echo "üéâ CI/CD Pipeline Completed Successfully!"
        echo "üìä SonarQube Report: ${{ secrets.SONARQUBE_URL }}/dashboard?id=todo-app"
        echo "üê≥ Docker Image: $DOCKER_IMAGE:$VERSION"
        echo "üåê Application URL: http://184.73.21.57:8080/todos"
